name: Convert Sigma rules into Zircolite JSON format

on:
  workflow_dispatch:
  push:
    branches:
      - "main"
  schedule:
    - cron: '*/5 * * * *'

jobs:
  rules-gen:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup PDM
        uses: pdm-project/setup-pdm@v4
        with:
          python-version: '3.11'

      - name: Git Submodules Update
        run: |
          git pull --recurse-submodules
          git submodule update --remote --recursive

      - name: Install Dependencies
        run: |
          pdm install --no-self

      - name: Prepare Sigma rules
        shell: bash
        continue-on-error: true
        run: |
          # Copy additional rule directories into windows rules
          cp -r ./sigma/rules-threat-hunting/ ./sigma/rules/windows/rules-threat-hunting/ 2>/dev/null || true
          cp -r ./sigma/rules-emerging-threats/ ./sigma/rules/windows/rules-emerging-threats/ 2>/dev/null || true
          # Remove markdown files to avoid processing issues
          find ./sigma/ -type f -name '*.md' -delete

      - name: Generate Zircolite rules with pySigma
        shell: bash
        continue-on-error: true
        run: |
          pdm run python3 gen_ruleset.py

      - name: Commit and Push
        uses: EndBug/add-and-commit@v9
        with:
          add: '.'
          author_name: wagga40
          default_author: user_info
          message: 'Rules Update'
